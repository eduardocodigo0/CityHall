name: Build and Release APK

on:
  push:
    tags:
      - 'v*.*.*'  # Triggered on version tags like v1.0.0, v2.1.3, etc.
  workflow_dispatch:  # Allows manual trigger

jobs:
  build:
    runs-on: ubuntu-latest

    permissions:
      contents: write  # Required to create releases

    steps:
    - uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: gradle

    - name: Grant execute permission for gradlew
      run: chmod +x gradlew

    - name: Build Debug APK
      run: ./gradlew assembleDebug

    - name: Get version name
      id: version
      run: |
        if [[ "${{ github.ref }}" == refs/tags/* ]]; then
          echo "name=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
        else
          echo "name=v$(date +'%Y%m%d-%H%M%S')" >> $GITHUB_OUTPUT
        fi

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.name }}
        name: Release ${{ steps.version.outputs.name }}
        draft: false
        prerelease: false
        files: |
          app/build/outputs/apk/debug/*.apk
        body: |
          ## üì± CityHall Release ${{ steps.version.outputs.name }}
          
          ### Download
          Download the APK file below and install it on your Android device.
          
          ### ‚ö†Ô∏è Debug Version - Important Information
          This is a **debug build** signed with debug keystore for testing purposes.
          
          **Why debug signing?**
          This decision was made to simplify the release process, as this app is **not intended for official publication** on the Google Play Store. It's a community/educational project designed for direct distribution.
          
          ### üìã Limitations & Notes
          
          **Please be aware of the following limitations:**
          - ‚ùå **Cannot be published on Google Play Store** - Debug signed apps are rejected
          - ‚ùå **Cannot update over different signatures** - If you have a version signed differently, you'll need to uninstall first
          - ‚ö†Ô∏è **Not optimized** - Contains debug code and logging (slightly larger APK size)
          - ‚ö†Ô∏è **Debug certificate** - Uses Android's default debug keystore
          
          **Advantages:**
          - ‚úÖ **Easy distribution** - Simple to build and share
          - ‚úÖ **No complex setup** - No need for keystore management
          - ‚úÖ **Perfect for testing** - Ideal for community testing and development
          - ‚úÖ **Fully functional** - All features work as expected
          
          ### üì¶ Build Information
          - Built from commit: `${{ github.sha }}`
          - Triggered by: @${{ github.actor }}
          - Build date: ${{ steps.version.outputs.name }}
          
          ### üì≤ Installation Instructions
          1. Download the APK file (app-debug.apk) from the assets below
          2. On your Android device, go to Settings ‚Üí Security
          3. Enable "Install from Unknown Sources" or "Install Unknown Apps"
          4. Open the downloaded APK file
          5. Follow the installation prompts
          6. Enjoy the app!

      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

